---
title: "mhlea_merge"
author: "Carolina Guidolin"
date: "2023-11-17"
output: html_document
---



##This script looks into the subjective light exposure that individuals report during the week

###Importing the files
First, we need to import the xlsx files which contain the transcribed mHLEA questionnaire. Paticipants filled this in on paper and the researcher transcribed them to an excel table in long format. Let's load them in.

```{r}
library(tidyverse)
library(hms)
library(here)
library(scales)
library(lubridate)
library(readxl)
library(ggrepel)
```


```{r cars}
filepath <- here("D:/cyepi/code/sublightexp_analysis/mHLEA_transcribed")

# Get the files names from directory
mhleafiles = list.files(filepath, pattern="*.xlsx", full.names = TRUE)

# Create an empty data frame to store the combined data
mhlea_df <- data.frame()

# Loop through each file
for (file in mhleafiles) {
  # Extract participant ID from the file name
  record_id <- substr(basename(file), 1, 3)
  
  # Read the Excel file
  df <- read_excel(file)
  
  # Check if "activity" column exists before converting its type
  if ("activity" %in% colnames(df)) {
    df$activity <- as.character(df$activity)
  }
  
  # Add participant ID column
  df$Id <- record_id
  
  # Combine data frames
  mhlea_df <- bind_rows(mhlea_df, df)
}
```
We actually only care about the light, and not the activity, in our first analysis
```{r}
tz = "Europe/Berlin"

mhlea_df <- mhlea_df %>%
  select(main_light, second_light, Id, lightsource, timestamp) %>%
  force_tz(timestamp, tzone = tz)
```


The first 16 participants had the information stored in the columns main_light and second_light. Let's bring them together under lightsource

```{r}
for (Id in 201:216) {
  # Create a subset for the participant
  subset_df <- mhlea_df[mhlea_df$Id == as.character(Id), ]
  
    # Create a new "lightsource" column by pasting values from "main_light" and "second_light"
  subset_df$lightsource <- paste(subset_df$main_light, subset_df$second_light, sep = "+")
    
    # Update the combined data frame with the modified subset
  mhlea_df[mhlea_df$Id == as.character(Id), ] <- subset_df
  
}

# Select columns
mhlea_df <- mhlea_df %>%
  select(Id, lightsource, timestamp)


# Handle NA+NA, NA+(character), and (something)+NA cases
mhlea_df$lightsource <- str_replace_all(mhlea_df$lightsource, "NA\\+", "")  # Remove NA+ part
mhlea_df$lightsource <- gsub("\\+NA", "", mhlea_df$lightsource)  # Remove +NA part
mhlea_df$lightsource <- gsub("NA+NA", NA, mhlea_df$lightsource)  # Replace NA+NA with NA

# Replace any empty strings with NA
mhlea_df$lightsource[mhlea_df$lightsource == ""] <- NA
mhlea_df$lightsource[mhlea_df$lightsource == "NA"] <- NA

navalues <- mhlea_df %>%
  filter(is.na(lightsource))
```


### Incorporate questionnaire to light logger data 
```{r}

mhlea_df <- mhlea_df %>%
  sc2interval(Datetime.colname = timestamp, Statechange.colname = lightsource, full = FALSE, length.restriction = 60*60*24) 

mhlea_LL_combined <- data.LL.binned %>%
  interval2state(mhlea_df) %>%
  select(-lightsource)

##We only want to keep the first light exposure category indicated by the participants 
mhlea_LL_combined$State <- gsub("\\+(.+)", "", mhlea_LL_combined$State)
                    
```

## Plot light exposure of one participant over time

You can also embed plots, for example:

```{r pressure, echo=FALSE}
library("cowplot")

mhlea_205 <- mhlea_LL_combined %>%
  filter(Id == 205) %>%
  select(Id, Datetime, State, MEDI) %>%
  mutate(randomdate = as.Date(Datetime, tz = tz))

mhlea_205_singleday <- mhlea_205 %>%
  filter(randomdate == as.Date("2023-09-02", tz = tz))

mhlea_205_singleday <- mhlea_205_singleday %>%
  force_tz(randomdate, tzone = "Europe/Berlin") %>%
  mutate(statenames = case_when(
    State == "X" ~ "Sleeping",
    State == "O" ~ "Daylight outdoors",
    State == "L" ~ "Electric light indoors",
    State == "I" ~ "Daylight indoors",
    TRUE ~ as.character(State)
  ))


weekendday_205_sub <- ggplot(mhlea_205_singleday, aes(x = Datetime, y = State, color = State)) +
  geom_point() +
  geom_label(aes(label = ifelse(duplicated(State), "", statenames)),
                   max.overlaps = Inf,
                   segment.color = NA,
                   nudge_x = 0.3,
                   nudge_y = 0.3,
                   hjust = -0.17) +
  scale_x_datetime(
    labels = scales::time_format(format = "%H:%M", tz = tz),
    breaks = "3 hours",
    limits = as.POSIXct(c("2023-09-02 00:00:00", "2023-09-03 00:00:00"), tz = tz),
    expand = c(0,0)
  ) +
  scale_color_manual(name = "Light sources",
                     labels = c("Daylight indoors", "Electric light source indoors", "Daylight outdoors", "Sleeping"),
                     values = c("#0099CC", "#FFCC00", "#0066CC", "black")) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 12)) +
     #   legend.position = "none",
      #  plot.title = ) +
  labs(x = "Time of day", y = "Light source", title = "Self-reported light exposure over a "~italic(weekend)~" day") +
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
ggplot2::ggsave(plot = weekendday_205_sub, filename = "205weekend_day_sub.png", width = 7, height = 4, dpi = 600, bg = "white")
```

```{r}
mHLEA_boxplot <- data.LL.filtered %>%
  interval2state(mhlea_df) %>%
  select(-lightsource) %>%
  filter(!is.na(State))

##We only want to keep the first light exposure category indicated by the participants 
mHLEA_boxplot$State <- gsub("\\+(.+)", "", mHLEA_boxplot$State)
mHLEA_boxplot$State <- gsub("W", "X", mHLEA_boxplot$State)

mHLEA_boxplot2 <- mHLEA_boxplot %>%
  mutate(hour= hour(Datetime)) %>%
           group_by(Date = as.Date(Datetime, tz = tz), hour, State, Id) %>%
           summarise(mean_medi = mean(MEDI, na.rm = TRUE)) %>%
          filter(!is.na(State))

options(scipen = 999)

new_order <- with(mHLEA_boxplot, reorder(as.factor(State) , MEDI, median , na.rm=T))
mHLEA_boxplot$State <- factor(mHLEA_boxplot$State, levels = c("D", "X", "E", "L", "S", "I", "O"))

ggplot(mHLEA_boxplot, aes(x = State, y = MEDI)) +
  geom_violin(alpha = 0.3, aes(fill = State), trim = FALSE) + 
  geom_boxplot(width = 0.2) +
  scale_y_log10(
    breaks = c(0.1, 1, 10, 100, 1000, 10000, 100000),
    labels = c("0.1", "1", "10", "100", "1000", "10000", "100000")
  ) +
  scale_fill_manual(
    name = "Light sources",
    values = c("D" = "black" ,
               "X" = "#999999",
               "E" = "#99FFFF",
               "L" = "#FFCC33",
               "S" = "#FF9933",
               "I" = "#0099CC",
               "O" = "#0066CC"),
    labels = c("Darkness (outdoors/indoors)",
               "Sleeping",
               "Emissive displays",
               "Electric light indoors",
               "Electric light outdoors",
               "Daylight indoors",
               "Daylight outdoors")) +
  theme_bw() +
  labs(x = "Light source", y = "Melanopic equivalent daylight illuminance (mEDI) [lux]", title = "Objective light exposure by self-reported light environment") + 
  theme(plot.title = element_text(hjust = 0.5))
  
```

```{r}
Sys.setlocale("LC_TIME", "en_US.UTF-8")
mHLEA_boxplot2$day <- format(mHLEA_boxplot2$Date, format = "%A", locale="English")
```

### We need to load in all the data from the participants
```{r}
setwd("D:/cyepi/data/raw/group/demographics")

filedem <- "D:/cyepi/data/raw/group/demographics/201_231_demog_20231123.csv"

demographics <- read.csv(file = filedem, sep = ";", fileEncoding = "UTF-8")

demographics_select <- demographics %>%
  select(record_id, age, sex, employment_status) %>%
  rename(Id = record_id) %>%
  mutate(Id = as.character(Id))

mHLEA_ancova <- 
  left_join(demographics_select, mHLEA_boxplot2, by = "Id")

mHLEA_ancova <- mHLEA_ancova %>%
  left_join(msf_sc, by = "Id")
  
```

```{r}
State
```

