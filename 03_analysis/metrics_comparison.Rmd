---
title: "metrics_comparison"
author: "Carolina Guidolin"
date: "2024-11-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Calculating metrics using different datasets
This script should be run after classification_summary. 

The aim of this script is to calculate and compare light metrics on three different datasets:
1. A raw dataset, where non-wear information is ignored (i.e., we include all data regardless of whether it is wear or non-wear)
2. A dataset where non-wear information is identified using self-reported non-wear time (wear log)
3. A dataset where non-wear information is identified by detecting clusters of low illuminance

### Creation of the three datasets
Before performing the comparison, we need to identify these three datasets. 
```{r}
# 1. Raw dataset: this is the raw data, i.e. dataset.LL.wrlg
raw_dataset <- dataset.LL.wrlg

# 2. Non-wear by wear log dataset. We need to create this from dataset.LL.wrlg
nw_wrlg <- dataset.LL.wrlg %>% 
  mutate(MEDI = if_else(State == "off", NA, MEDI))

#3. Non-wear by detection of clusters of low illuminance. We will use the dataset where padding has been added to transition states (see script classification_summary.Rmd). 
nw_clusters <- nw_alg_padded %>%
  mutate(MEDI = if_else(is_low_medi_cluster == 0, NA, MEDI))

```

### Data prep
```{r}
# Exclude Monday since this day does not contain full data. Do this for all three data frames
raw_dataset <- raw_dataset %>% dplyr::filter(weekdays(Datetime) != "Monday")
nw_wrlg <- nw_wrlg %>% dplyr::filter(weekdays(Datetime) != "Monday")
nw_clusters <- nw_clusters %>% dplyr::filter(weekdays(Datetime) != "Monday")
```

### 1. Calculating intradaily stability 
```{r}
# 1a. raw dataset
is_raw_dataset <- raw_dataset %>% 
  summarize(
    IS_raw = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime
    )
  )

# 1b. With Wear log based non-wear 
is_nw_wrlg <- nw_wrlg %>% 
  summarize(
    IS_wrlg = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  )

# 1c. With cluster based non-wear
is_nw_clusters <- nw_clusters %>%
  group_by(Id) %>% #we need to group here, because this df is not directly generate in LightLogR
  # and hence the data is not grouped by Id by default (as is the case for the other 2 data frames)
  summarize(
    IS_clusters = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  ) %>% 
  ungroup()

# Combining the dfs 
temp <- full_join(is_raw_dataset, is_nw_wrlg, by = "Id") #first, combine raw and wrlg data sets
is_all <- full_join(temp, is_nw_clusters, by = "Id") #second, add clusters data set

# Turning df into long form to perform computations
is_all_long <- is_all %>%
  pivot_longer(cols = c("IS_raw", "IS_wrlg", "IS_clusters"),
                        names_to = "df",
                        values_to = "is")

# Compute sign test
library(rstatix)

is_sign <- is_all_long %>%
  rstatix::sign_test(is ~ df) %>%
  add_significance()


```

#### Plotting intradaily stability
```{r}
# Raw vs clean (wrlg)
clean_wrlg <- ggpubr::ggscatter(data = is_all,
          x = "IS_raw",
          y = "IS_wrlg",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 0.95) +
  ggplot2::scale_x_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) +
  scale_y_continuous(limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (Wear log)") +
  coord_fixed(ratio = 1)

# Raw vs clean (clusters) - why 218 has 1.2??
clean_clusters <- ggpubr::ggscatter(data = is_all,
          x = "IS_raw",
          y = "IS_clusters",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 0.95) +
  ggplot2::scale_x_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) +
  scale_y_continuous(limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (algorithm)") +
  coord_fixed(ratio = 1)

# Combining the plots
p <- ggpubr::ggarrange(clean_wrlg, clean_clusters,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

is_comparison <- ggpubr::annotate_figure(p, top = text_grob("Interdaily stability")) 

```

### Calculating batch metrics for each participants on each day of the experimental week 
- MLIT250
- TAT250
- Average MEDI
- 
```{r}
batch_raw <- raw_dataset %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

batch_wrlg <- nw_wrlg %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

batch_clusters <- nw_clusters %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

# Batch metrics for raw dataset
batch_raw <- 
  batch_raw %>% 
  group_by(Id, wDay) %>% 
  summarize(
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE),
    average_MEDI = 
      mean(MEDI),
    light_exposure = 
      sum(MEDI)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

# Batch metrics for nw_wrlg dataset
batch_wrlg <- 
  batch_wrlg %>% 
  group_by(Id, wDay) %>% 
  summarize(
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    average_MEDI = 
      mean(MEDI, na.rm = TRUE),
    light_exposure = 
      sum(MEDI, na.rm = TRUE)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

# Batch metrics for nw_clusters dataset
batch_clusters <- 
  batch_clusters %>% 
  group_by(Id, wDay) %>% 
  summarize(
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    average_MEDI = 
      mean(MEDI, na.rm = TRUE),
    light_exposure = 
      sum(MEDI, na.rm = TRUE)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

```

### TAT250 analysis
```{r}
raw_tat250 <- batch_raw %>% select(Id, wDay, mean_timing_above_250)
wrlg_tat250 <- batch_wrlg %>% select(Id, wDay, mean_timing_above_250)
clusters_tat250 <- batch_clusters %>% select(Id, wDay, mean_timing_above_250)

# Combining the dfs 
temp <- full_join(raw_tat250, wrlg_tat250, by = c("Id", "wDay")) %>%
  rename(raw_tat250 = mean_timing_above_250.x, wrlg_tat250 = mean_timing_above_250.y) #first, combine raw and wrlg data sets
tat250_all <- full_join(temp, clusters_tat250, by = c("Id", "wDay")) %>%
  rename(clusters_tat250 = mean_timing_above_250) #second, add clusters data set

tat250_means <- tat250_all %>%
  group_by(Id) %>%
  summarise(mean_raw = mean(raw_tat250),
         sd_raw = sd(raw_tat250),
         mean_wrlg = mean(wrlg_tat250),
         sd_wrlg = sd(wrlg_tat250),
         mean_clusters = mean(clusters_tat250),
         sd_clusters = sd(clusters_tat250))


```

#### Plotting TAT250
```{r}
# Raw vs clean (wrlg)
clean_wrlg_tat <- ggpubr::ggscatter(data = tat250_means,
          x = "mean_raw",
          y = "mean_wrlg",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 0.95) + 
  ggplot2::geom_errorbar(data = tat250_means,
                         aes(ymin=mean_wrlg-sd_wrlg)) 
  labs(x = "Raw dataset", y = "Clean dataset (Wear log)") +
  coord_fixed(ratio = 1)
```

