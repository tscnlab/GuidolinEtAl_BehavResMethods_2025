---
title: "metrics_comparison"
author: "Carolina Guidolin"
date: "2024-11-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Calculating metrics using different datasets
This script should be run after classification_summary. 

The aim of this script is to calculate and compare light metrics on three different datasets:
1. A raw dataset, where non-wear information is ignored (i.e., we include all data regardless of whether it is wear or non-wear)
2. A dataset where non-wear information is identified using self-reported non-wear time (wear log)
3. A dataset where non-wear information is identified by detecting clusters of low illuminance

### Creation of the three datasets
Before performing the comparison, we need to identify these three datasets. 
```{r}
# 1. Raw dataset: this is the raw data, i.e. dataset.LL.wrlg
raw_dataset <- dataset.LL.wrlg

# 2. Non-wear by wear log dataset. We need to create this from dataset.LL.wrlg
nw_wrlg <- dataset.LL.wrlg %>% 
  mutate(MEDI = if_else(State == "off", NA, MEDI))

#3. Non-wear by detection of clusters of low illuminance. We will use the dataset where padding has been added to transition states (see script classification_summary.Rmd). 
nw_clusters <- nw_alg_padded %>%
  mutate(MEDI = case_when(
    is.na(is_low_medi_cluster) ~ MEDI, # When is_low_medi_cluster is NA, retain MEDI
    is_low_medi_cluster == 0 ~ NA, # When is_low_medi_cluster is 0, set MEDI to NA
    TRUE ~ MEDI # For all other cases, retain MEDI
  ))

```

### Data prep
```{r}
# Exclude Monday since this day does not contain full data. Do this for all three data frames
raw_dataset <- raw_dataset %>% dplyr::filter(weekdays(Datetime) != "Monday")
nw_wrlg <- nw_wrlg %>% dplyr::filter(weekdays(Datetime) != "Monday")
nw_clusters <- nw_clusters %>% dplyr::filter(weekdays(Datetime) != "Monday")
```

### 1. Calculating interdaily stability 
```{r}
# 1a. raw dataset
is_raw_dataset <- raw_dataset %>% 
  summarize(
    IS_raw = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime
    )
  )

# 1b. With Wear log based non-wear 
is_nw_wrlg <- nw_wrlg %>% 
  summarize(
    IS_wrlg = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  )

# 1c. With cluster based non-wear
is_nw_clusters <- nw_clusters %>%
  group_by(Id) %>% #we need to group here, because this df is not directly generate in LightLogR
  # and hence the data is not grouped by Id by default (as is the case for the other 2 data frames)
  summarize(
    IS_clusters = interdaily_stability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  ) %>% 
  ungroup()

# Combining the dfs 
temp <- full_join(is_raw_dataset, is_nw_wrlg, by = "Id") #first, combine raw and wrlg data sets
is_all <- full_join(temp, is_nw_clusters, by = "Id") #second, add clusters data set

# Turning df into long form to perform computations
is_all_long <- is_all %>%
  pivot_longer(cols = c("IS_raw", "IS_wrlg", "IS_clusters"),
                        names_to = "df",
                        values_to = "is")

# Compute sign test
library(rstatix)

is_sign <- is_all_long %>%
  rstatix::sign_test(is ~ df) %>%
  add_significance()


```

#### Plotting interdaily stability
```{r}
# Raw vs clean (wrlg)
clean_wrlg <- ggpubr::ggscatter(data = is_all,
          x = "IS_raw",
          y = "IS_wrlg",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 0.95) +
  geom_abline(intercept = 0, slope = 1, colour = "darkgrey", linetype = "dashed") + # adding unity line
  ggplot2::scale_x_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) +
  scale_y_continuous(limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (Wear log)") +
  coord_fixed(ratio = 1)

# Raw vs clean (clusters) 
clean_clusters <- ggpubr::ggscatter(data = is_all,
          x = "IS_raw",
          y = "IS_clusters",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 0.95) +
   geom_abline(intercept = 0, slope = 1, colour = "darkgrey", linetype = "dashed") + # adding unity line
  ggplot2::scale_x_continuous(
    limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) +
  scale_y_continuous(limits = c(0, 1),
    breaks = c(0, 0.50, 1), 
    labels = c("0", "0.50", "1")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (algorithm)") +
  coord_fixed(ratio = 1)


# Combining the plots
p1 <- ggpubr::ggarrange(clean_wrlg, clean_clusters,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

is_comparison <- ggpubr::annotate_figure(p, top = text_grob("Interdaily stability", size = 18)) 

is_comparison
```

### 2. Calculating intradaily variability
```{r}
# 1a. raw dataset
iv_raw_dataset <- raw_dataset %>% 
  summarize(
    IV_raw = intradaily_variability(
      Light.vector = MEDI,
      Datetime.vector = Datetime
    )
  )

# 1b. With Wear log based non-wear 
iv_nw_wrlg <- nw_wrlg %>% 
  summarize(
    IV_wrlg = intradaily_variability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  )

# 1c. With cluster based non-wear
iv_nw_clusters <- nw_clusters %>%
  group_by(Id) %>% #we need to group here, because this df is not directly generate in LightLogR
  # and hence the data is not grouped by Id by default (as is the case for the other 2 data frames)
  summarize(
    IV_clusters = intradaily_variability(
      Light.vector = MEDI,
      Datetime.vector = Datetime,
      na.rm = TRUE
    )
  ) %>% 
  ungroup()

# Combining the dfs 
temp <- full_join(iv_raw_dataset, iv_nw_wrlg, by = "Id") #first, combine raw and wrlg data sets
iv_all <- full_join(temp, iv_nw_clusters, by = "Id") #second, add clusters data set
```

#### Plotting intradaily variability 
```{r}
# Raw vs clean (wrlg)
clean_wrlg <- ggpubr::ggscatter(data = iv_all,
          x = "IV_raw",
          y = "IV_wrlg",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 1.95) +
  geom_abline(intercept = 0, slope = 1, colour = "darkgrey", linetype = "dashed") + # adding unity line
  ggplot2::scale_x_continuous(
    limits = c(0, 2),
    breaks = c(0, 0.50, 1, 1.5, 2), 
    labels = c("0", "0.50", "1", "1.5", "2")
  ) +
  scale_y_continuous(
   limits = c(0, 2),
    breaks = c(0, 0.50, 1, 1.5, 2), 
    labels = c("0", "0.50", "1", "1.5", "2")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (Wear log)") +
  coord_fixed(ratio = 1)

# Raw vs clean (clusters) 
clean_clusters <- ggpubr::ggscatter(data = iv_all,
          x = "IV_raw",
          y = "IV_clusters",
          color = "Id",
          ggtheme = theme_bw()) +
    ggpubr::stat_cor(aes(label = after_stat(r.label)), # add r coefficient but not p value
                   method = "pearson",
                   label.x = 0.03,
                   label.y = 1.95) +
   geom_abline(intercept = 0, slope = 1, colour = "darkgrey", linetype = "dashed") + # adding unity line
  ggplot2::scale_x_continuous(
    limits = c(0, 2),
    breaks = c(0, 0.50, 1, 1.5, 2), 
    labels = c("0", "0.50", "1", "1.5", "2")
  ) +
  scale_y_continuous(
   limits = c(0, 2),
    breaks = c(0, 0.50, 1, 1.5, 2), 
    labels = c("0", "0.50", "1", "1.5", "2")
  ) + 
  labs(x = "Raw dataset", y = "Clean dataset (algorithm)") +
  coord_fixed(ratio = 1)


# Combining the plots
p2 <- ggpubr::ggarrange(clean_wrlg, clean_clusters,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

iv_comparison <- ggpubr::annotate_figure(p2, top = text_grob("Intradaily variability", size = 18)) 

iv_comparison
```
### Calculating batch metrics for each participants on each day of the experimental week 
- MLIT250, FLIT250, LLIT250
- MLIT10, FLIT10, LLIT10
- TAT250, TAT1000
- Average MEDI
- LE
```{r}
batch_raw <- raw_dataset %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

batch_wrlg <- nw_wrlg %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

batch_clusters <- nw_clusters %>%
  LightLogR::create_Timedata() %>%
  mutate(wDay = wday(Datetime, label = TRUE, week_start = 1))

# Batch metrics for raw dataset
batch_raw <- 
  batch_raw %>% 
  group_by(Id, wDay) %>% 
  summarize(
    MLIT10 = #Note: This creates 1) mean timing above threshold, 2) first timing above threshold, 3) last timing above threshold
      timing_above_threshold(MEDI, Time.data, threshold = 10, as.df = TRUE, na.rm = TRUE),
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    MLIT1000 = 
      timing_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    TAT1000 = 
      duration_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    average_MEDI = 
      mean(MEDI, na.rm = TRUE),
    light_exposure = 
      sum(MEDI, na.rm = TRUE)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

# Batch metrics for nw_wrlg dataset
batch_wrlg <- 
  batch_wrlg %>% 
  group_by(Id, wDay) %>% 
  summarize(
     MLIT10 =
      timing_above_threshold(MEDI, Time.data, threshold = 10, as.df = TRUE, na.rm = TRUE),
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    MLIT1000 = 
      timing_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    TAT1000 = 
      duration_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    average_MEDI = 
      mean(MEDI, na.rm = TRUE),
    light_exposure = 
      sum(MEDI, na.rm = TRUE)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

# Batch metrics for nw_clusters dataset
batch_clusters <- 
  batch_clusters %>% 
  group_by(Id, wDay) %>% 
  summarize(
     MLIT10 = 
      timing_above_threshold(MEDI, Time.data, threshold = 10, as.df = TRUE, na.rm = TRUE),
    MLIT250 = 
      timing_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    MLIT1000 = 
      timing_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    TAT250 = 
      duration_above_threshold(MEDI, Time.data, threshold = 250, as.df = TRUE, na.rm = TRUE),
    TAT1000 = 
      duration_above_threshold(MEDI, Time.data, threshold = 1000, as.df = TRUE, na.rm = TRUE),
    average_MEDI = 
      mean(MEDI, na.rm = TRUE),
    light_exposure = 
      sum(MEDI, na.rm = TRUE)/360, # 10 second epochs means 360 epochs in one hour. dividing by 360 gives the light exposure in lx·h
    .groups = "drop_last"
    ) %>% 
  unnest(-Id)

```

## Calculating timing metrics
In the following chunks, we will calculate "timing metrics":
- MLiT 10, MLiT250, MLiT1000
- FLiT 10, FLiT 250, FLiT 1000
- LLit 10, LLiT 250, LLit 1000
To facilitate these calculations, we wrote a function (calculate_metric_fun.R script) that takes the tree datasets and calculates ean and sd for the timing metric of interest. 

### MLiT 10 analysis
```{r}
# Calculating
mlit10_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "mean_timing_above_10"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = mlit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = mlit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p3 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

mlit10_comparison <- ggpubr::annotate_figure(p3, top = text_grob("Time above threshold (10 mEDI lux)", size = 18)) 

mlit10_comparison
```
### MLiT250 analysis
```{r}
# Calculation 
mlit250_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "mean_timing_above_250"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = mlit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = mlit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p4 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

mlit250_comparison <- ggpubr::annotate_figure(p4, top = text_grob("Time above threshold (250 mEDI lux)", size = 18)) 

mlit250_comparison
```
#### MLiT 1000 analysis
```{r}
# Calculation 
mlit1000_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "mean_timing_above_1000"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = mlit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = mlit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p5 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

mlit1000_comparison <- ggpubr::annotate_figure(p5, top = text_grob("Time above threshold (1000 mEDI lux)", size = 18)) 

mlit1000_comparison
```
### FLiT 10 analysis
```{r}
# Calculation 
flit10_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "first_timing_above_10"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = flit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = flit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p6 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

flit10_comparison <- ggpubr::annotate_figure(p6, top = text_grob("First time above threshold (10 mEDI lux)", size = 18)) 

flit10_comparison
```
### FLiT 250 analysis
```{r}
# Calculation 
flit250_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "first_timing_above_250"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = flit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = flit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p7 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

flit250_comparison <- ggpubr::annotate_figure(p7, top = text_grob("First time above threshold (250 mEDI lux)", size = 18)) 

flit250_comparison
```

### FLiT 1000 comparison 
```{r}
# Calculation 
flit1000_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "first_timing_above_1000"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = flit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = flit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p8 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

flit1000_comparison <- ggpubr::annotate_figure(p8, top = text_grob("First time above threshold (1000 mEDI lux)", size = 18)) 

flit1000_comparison
```
### LLiT 10 analysis
```{r}
# Calculation 
llit10_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "last_timing_above_10"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = llit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = llit10_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p9 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

llit10_comparison <- ggpubr::annotate_figure(p9, top = text_grob("Last time above threshold (10 mEDI lux)", size = 18)) 

llit10_comparison
```
### LLiT 250 analysis
```{r}
# Calculation 
llit250_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "last_timing_above_250"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = llit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = llit250_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p10 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

llit250_comparison <- ggpubr::annotate_figure(p10, top = text_grob("Last time above threshold (250 mEDI lux)", size = 18)) 

llit250_comparison
```
### LLiT 1000 analysis
```{r}
# Calculation 
llit1000_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "last_timing_above_1000"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = llit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = llit1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p11 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

llit1000_comparison <- ggpubr::annotate_figure(p11, top = text_grob("Last time above threshold (1000 mEDI lux)", size = 18)) 

llit1000_comparison
```
### TAT 250 analysis
```{r}
# Calculation 
tat250_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "duration_above_250"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = tat250_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = tat250_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p12 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

tat250_comparison <- ggpubr::annotate_figure(p12, top = text_grob("Duration above threshold (250 mEDI lux)", size = 18)) 

tat250_comparison
```
### TAT 1000 comparison
```{r}
# Calculation 
tat1000_all <- calculate_metric(
  raw_df = batch_raw,
  wrlg_df = batch_wrlg,
  clusters_df = batch_clusters,
  metric = "duration_above_1000"
)

# Plotting
## Raw vs wrlg
raw_vs_wrlg_vis <- visualize_comparison(
  data = tat1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_wrlg", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean Wear log dataset)",
)

## Raw vs clusters
raw_vs_clusters_vis <- visualize_comparison(
  data = tat1000_all, 
  x_col = "mean_raw", 
  y_col = "mean_clusters", 
  x_label = "Mean time (Raw dataset)", 
  y_label = "Mean time (Clean algorithm dataset)",
)

## Combining the plots
p13 <- ggpubr::ggarrange(raw_vs_wrlg_vis, raw_vs_clusters_vis,
                                labels = c("A", "B"),
                                ncol = 2,
                                nrow = 1,
                                align = "hv",
                       common.legend = TRUE,
                       legend = "right")

tat1000_comparison <- ggpubr::annotate_figure(p13, top = text_grob("Duration above threshold (1000 mEDI lux)", size = 18)) 

tat1000_comparison
```


