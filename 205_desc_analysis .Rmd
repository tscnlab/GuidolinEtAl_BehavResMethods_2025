---
title: "205_LightLogR"
output: html_document
date: "2023-09-29"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Loading necessary packages

You can also embed plots, for example:

```{r}
library(LightLogR)
library(tidyverse)
library(gt)
library(patchwork)
```
## Importing data
1. Light logger data
2. Environmental data (from rooftop sensor)
3. Sleep diary data 


```{r}
file.LL <- "205_actlumus_Log_1020_20230904101707532.txt"
file.env <- "cyepiamb_CW35_Log_1431_20230904081953614.txt"
file.sleep <- "205_sleepdiary_all_20230904.csv"
```

## Work with personal light exposure data 
We now create a dataset for the personal light exposure data for participant 212. We also want to filter the Datetime so that we start at the first timestamp and end on Sunday night. The timestamp information is taken from the quality_check37.xlsx file. 
```{r}
tz <- "Europe/Berlin"
dataset.LL <- import$ActLumus(file.LL, auto.id = "^(\\d{3})", tz = tz)

#We would like to filter according to when exactly the participant started and ended the experiment
dataset.LL <- dataset.LL %>%
  filter_Datetime(start = "2023-08-28 15:41:00", end = "2023-09-03 23:59:59")
```

## Visualisation of personal light exposure over 7 days 
We start by a simple visualisation of the participant's light exposure over the seven days of participation. To gain a little insight into the MEDI levels we are dealing with, we colour the MEDI datapoints >250 lx as orange and the ones <250 lx as light blue. 
```{r}
dataset.LL %>%
  gg_day(size = 0.25, color = "#EFC000", geom = "line", x.axis.label = "Time", title = "P205 light exposure over 7 days") +
  theme(plot.title = element_text(hjust = 0.5))
```
We see that a lot of datapoints are <0 lx. This is because this is raw data - meaning it includes non-wear time when participants placed the light glasses in the black bag (and thus MEDI ~0 lx). 
## Importing the environmental dataset for the corresponding week
```{r}
dataset.env <- import$ActLumus(file.env, manual.id = "CW35", tz = tz)

#Here as well, we would like to filter according to when the participant started, so we apply the same timestamps to the dataset.env
dataset.env <- dataset.env %>%
  filter_Datetime(start = "2023-08-28 15:41:00", end = "2023-09-03 23:59:59")
```

## Importing the sleep diary data 
Using the state changes function, we now also import data from the sleep diary. 
```{r}
dataset.sleep <- 
  import.Statechanges(file.sleep, 
                      Datetime.format = "dmyHM",
                      State.colnames = c("sleep", "offset"),
                      State.encoding = c("sleep", "wake"),
                      ID.colname = record_id,
                      sep = ";",
                      dec = ",",
                      tz = tz)

dataset.sleep %>% head() %>% gt()
```

## Combing the personal and environmental datasets
Using the data2reference function, we compare personal light exposure to a Reference - in this case the enviornmental light (daylight). Since sampling interval of cyepi_ambient is 30s and of personal light glasses is 10s, the same ref value is assignes to 3 consecutive participant values. 
```{r}
dataset.LL <- 
  dataset.LL %>% data2reference(Reference.data = dataset.env, across.id = TRUE)

dataset.LL <- 
  dataset.LL %>% select(Id, Datetime, MEDI, Reference) #removing unnecessary columns

dataset.LL %>% head() %>% gt()
```

## Visualise personal and environmental light exposure in one plot
```{r}
p205overview <- dataset.LL %>% 
  gg_day(size = 0.25, geom = "line", color = '#EFC000', x.axis.label = "Time", title = "P205 personal and environmental light exposure over 7 days") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_line(aes(y=Reference), lty = 2, col = "#0073C2FF")
```

## Recommendations from Brown et al (2022)
We convert the timepoints when a state changes into intervals during which the participants is either awake or asleep. 
```{r}
dataset.sleep <- dataset.sleep %>% sc2interval()

dataset.sleep %>% head() %>% gt()
```

Now we transform them into intervals for the Brown et al recommendations (evening/night/day)
```{r}
Brown.intervals <- dataset.sleep %>% sleep.int2Brown()

Brown.intervals %>% head() %>% gt()
```

We now apply this data to our dataset
```{r}
dataset.LL <- 
  dataset.LL %>% 
  interval2state(
    State.interval.dataset = Brown.intervals, State.colname = State.Brown, Interval.colname = Interval)
#dataset.LL %>% tail() %>% gt()
```

We now add the threshold of MEDI for each of the Brown "states" and check whether our participant is within this range
```{r}
dataset.LL <- dataset.LL %>% Brown2reference(Brown.rec.colname = Reference.Brown)
dataset.LL %>% select(!Reference.Brown.label) %>% tail() %>% gt()
```

Let's have a look at the data
```{r}
dataset.LL %>% #dataset
  gg_day(geom = "point", size = 0.25, color = '#EFC000', x.axis.label = "Time", title = "P205 personal and environmental light exposure over 7 days") + 
  theme(plot.title = element_text(hjust = 0.5)) + #base plot
  geom_line(aes(y=Reference), lty = 2, col = "#0073C2FF") + #solar reference
  geom_line(aes(y=Reference.Brown), lty = 1, col = "black") #Brown reference
```

## Zooming into one day 
```{r}
dataset.LL.partial <- 
dataset.LL %>% 
  filter_Date(start = "2023-09-02", length = days(1)) #use only one day

solar.reference <-   geom_line(aes(y=Reference), lty = 1, col = "#0073C2FF") #solar reference
brown.reference <-   geom_line(aes(y=Reference.Brown), lty = 2, col = "black") #Brown reference

dataset.LL.partial  %>% 
  gg_day(size = 0.25, facetting = FALSE, geom = "line", color = '#EFC000', x.axis.label = "Time") + #base plot
  solar.reference + brown.reference
```

## Styling the data 
```{r}
scale.correction <- coord_cartesian(
  ylim = c(0.1, 10^5), # tweak the y axis
  xlim = c(0, 24.5*60*60), #make sure the x axis covers 24 hours (+a bit for the label)
  expand = FALSE)  #set the axis limits exactly at ylim and xlim
```

##Aggregate the data 
Create aggregate function
```{r}
aggregate_Datetime2 <- function(...) {
  aggregate_Datetime(...) %>% #aggregate the data
  select(-Reference.Brown) %>% #remove the rounded 
  Brown2reference(Brown.rec.colname = Reference.Brown) #recalculate the brown times
    }
```

## Apply the aggregate function (here 5 minutes)
```{r}
Plot <- dataset.LL.partial %>% aggregate_Datetime2(unit = "5 mins")  %>% 
  gg_day(facetting = FALSE, geom = "ribbon", alpha = 0.25, size = 0.25,
         fill = "#EFC000", color = "#EFC000", x.axis.label = "Time of day") + #base plot
  solar.reference + brown.reference + scale.correction

```

## Style it 
```{r}
sat_plot_205 <- Plot + 
  geom_ribbon(aes(ymin = MEDI, ymax=Reference), alpha = 0.25, fill = "#0073C2FF") #solar reference
```

## Make a second plot 
```{r}
Day.end <- as_datetime("2023-09-02 23:59:59", tz = tz)

x <- 900
Day.start <- as_datetime("2023-09-02 00:00:00", tz = tz)

Brown.times <- 
  Brown.intervals %>% 
 # filter(int_overlaps(Interval)) %>% 
  mutate(ymin = case_match(State.Brown,
                           "night"  ~ 0,
                           "day" ~ 250,
                           "evening" ~ 0),
         ymax = case_match(State.Brown,
                           "night"  ~ 1,
                           "day" ~ Inf,
                           "evening" ~ 10),
         xmin = int_start(Interval),
         xmax = int_end(Interval),
         xmin = if_else(xmin < Day.start, Day.start, xmin)  %>% hms::as_hms(),
         xmax = if_else(xmax > Day.end, Day.end, xmax) %>% hms::as_hms()
         )

Brown.times <- 
  Brown.times %>% 
  mutate(xmean = (xmax - xmin)/2 + xmin,
         label.Brown = case_match(State.Brown,
                                  "night" ~ "sleep",
                                  "evening" ~ "pre-bed",
                                  .default = State.Brown))

Brown.times <- Brown.times[15:17,]

weekendday_205 <- dataset.LL.partial %>% 
  aggregate_Datetime2(unit = "5 mins") %>% filter_Datetime(end = Day.end) %>% 
  gg_day(facetting = FALSE, geom = "blank", 
         x.axis.label = "Time of day",
         title = "Example personal light exposure for "~italic(weekend)~" day") +
  theme(plot.title = element_text(hjust = 0.5)) +#base plot
    geom_ribbon(aes(ymin = MEDI, ymax=Reference), 
              alpha = 0.25, fill = "#0073C2FF",
              outline.type = "upper", col = "#0073C2FF", size = 0.15) + #solar reference
  geom_ribbon(aes(ymin = 0, ymax = MEDI), alpha = 0.30, fill = "#EFC000", 
              outline.type = "upper", col = "#EFC000", size = 0.4) + #ribbon geom
  scale.correction +
  #geom_point(aes(col = Reference.Brown.check), size = 0.5)+
  geom_line(aes(y=Reference.Brown, 
                # group = consecutive_id(State.Brown)
                ), 
            col = "grey40",
            lty = 2, size = 0.4) + #Brown reference
  scale_color_manual(values = c("grey50", "#EFC000"))+
  guides(color = "none") +
  geom_label(data = Brown.times, 
             aes(x = xmean, y = 0.5, label = label.Brown), 
             col = "grey40", alpha = 0.75) +
  annotate("text", x=x, y = 1.7, label = "Brown et al. (2022)", 
           hjust = 0, col = "grey25")


```

```{r}
ggplot2::ggsave(plot = weekendday_205, filename = "205weekend_day.png", width = 7, height = 4, dpi = 600, bg = "white")
```



```{r}
weekendday_205 / weekendday_205_sub
```


## Save the plots
First, we'll save the weekly overview with solar and Brown reference
```{r}
ggsave(filename = "205_weekoverview.pdf",
       plot = p205overview,
       width = 210, height = 297, units = "mm")
```

We can then save the single day plot
```{r}
ggsave(filename = "205_singleday.pdf",
       plot = plot205_singleday)
```

