---
title: "plots_wrlg"
author: "Carolina Guidolin"
date: "2024-05-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

### Plot the non-wear time according to the wear log
```{r}
Sys.setlocale("LC_TIME", "en_US.UTF-8") #needed to run this code to have the days displayed in English and not German

#Non-wear time can be calculated from the joined_int dataset
nonwear_time <-wrlg_int %>%
#filter for intervals on non-wear (State == "off")
  filter(State == "off") %>% 
  #calculate the non-wear time through the interval column
  mutate(off_time = int_length(Interval) %>% as_hms()) %>% 
  #group by date and summarize daily non-wear time
  mutate(Date = as.Date(int_end(Interval)), #first, Date and corresponding weekday are calculated
         day = format(Date, format = "%A", locale="English") %>% 
           forcats::fct_inorder()) %>%
  group_by(Id, day, .add = TRUE) %>%
  summarize(off_time = sum(off_time)) %>%
  ungroup()

#There are participants who have 0 non-wear time for a day, i.e. they have no State == off, who we still want to display as 0 points in our plot. Since we filtered for State == off above, we need to use complete to fill in days of 0 non-wear with 0 values. 
off_states <- off_states %>%
  complete(Id, day, fill = list(off_time = as_hms(0)))

off_states$off_time <- as.numeric(off_states$off_time, "hours")

```


```{r}
#plotting the data
nonwear_duration <- off_states %>% 
ggplot(aes(x = day, y = off_time)) +
  geom_violin(alpha = 0.3, aes(fill=day), trim = TRUE) + 
  geom_dotplot(binaxis = "y",
               stackdir = "center",
               dotsize = 0.5,
               binwidth = 0.1) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 26, face = "plain"),
        axis.text = element_text(size=18),
        axis.title = element_text(size=18),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.position = "none") +
  xlab("Experimental day") + 
  ylab("Non-wear time (hours)") +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10, 12, 14, 16), 
                     label = c(0, 2, 4, 6, 8, 10, 12, 14, 16), 
                     expand = c(0,0)) +
  ggtitle("Self-reported non-wear time entries (Wear log)")
```

###Saving  
```{r}
ggsave(filename = "nonwear_all.png",
       plot = nonwear_duration,
       width = 13,
       height = 14,
       dpi = 600,
       path= "F:/cyepi/code/outputs")

ggsave(filename = "nonwear_all.pdf",
       plot = nonwear_duration,
       width = 13,
       height = 14,
       dpi = 600,
       path= "F:/cyepi/code/outputs")
```

###While the plot above gives us an overview of the non-wear time for all participants, we would like to plot this as an histogram of non-wear time distribution, ranging from 0 non wear time to 100% non wear time

```{r}
#First, while all participants took part in the experiment for 7 days, they started at different times, and so it is important not just to approximate to 7 days (168 hours), but to calculate the specific 100% of "participation time" for each participant. For this, we first need to calculate the n of hours that each participant spends in the experiment.

exp_duration <- filtered_time %>%
  mutate(id_int = lubridate::interval(start, end),
         id_duration = lubridate::int_length(id_int) %>% as_hms()) %>% #tot hours of participation for each participant
  select(Id, id_duration)

```

###Visualise how much time participants spend in which State (on/off/sleep)
```{r}
library(ggdist)

#Time in each interval can be calculated from wrlg_int 
int_duration <- wrlg_int %>%
  group_by(Id) %>%
  #filter out the last "on" interval, since it goes to midnight of the final exp day, which is not actual data
  filter(row_number() != n()) %>% #this filters out the rows where row n is equal to tot number of rows, i.e. last enrty
  ungroup() %>%
  #calculate length of each individual interval
  mutate(int_length = int_length(Interval) %>% as_hms()) %>% 
  #group by Id and State to then  summarise the total (i.e. across the whole week) duration of each state (on/off/sleep) 
  group_by(Id, State, .add = TRUE) %>%
  summarize(tot_intlength = sum(int_length) %>% as_hms()) %>%
  ungroup() %>%
  #The first states for each Id (midnight of previous day to study start) are NA, we want to filter them out since they are not active participation
  filter(!is.na(State))

# Normalise it to the total time participants spent in the experiment, expressed in percentage
int_duration <- int_duration %>%
  left_join(exp_duration, by ="Id") %>% #append the column containing total participation hours from the exp_duration df
  mutate(id_duration_n= as.numeric(tot_intlength)/as.numeric(id_duration), #convert to numeric as division betwen difftime objects is not supported, n stands for "normalised"
         id_duration_per = id_duration_n*100) #calculate percentage of time


#Calculating median time in each state

summary <- int_types %>%
  group_by(State) %>%
  summarise(mean = mean(per_length),
            sd = sd(per_length),
            min = min(per_length),
            max = max(per_length),
            median = median(per_length),
            range = max-min) %>%
  ungroup()

as.factor(int_duration$State)

#Plot
int_duration$State <- factor(int_duration$State, levels = unique(int_duration$State)[order(int_duration$per_length, decreasing = TRUE)])

states_dist_jitter <- ggplot(data = int_duration, aes(x=id_duration_per, y = State, fill = State)) +
  xlim(NA,100) +
  ggdist::stat_halfeye(
    aes(colour = State,
        fill = State),
    adjust = .5,
    justification = -.25,
    point_color = NA,
    interval_color = NA
    ) +
  geom_boxplot(
    aes(color = State),
    width = .2,
    alpha = .2,
    outlier.shape = NA
  ) +
  geom_jitter(
    aes(colour = State),
    fill = "white",
    height = .1,
    alpha = .3
  ) +
  scale_fill_manual(
    values = c("off" = "#16439C", "on" = "palegreen4", "sleep" = "darkgoldenrod2")) +
  scale_color_manual(
    values = c("off" = "#16439C", "on" = "palegreen4", "sleep" = "darkgoldenrod2")) +
  scale_y_discrete(labels = c("on" = "On", "off" = "Off", "sleep" = "Off while\nsleeping")) +
  theme_classic() +
  ggpubr::rremove("ylab") +
  ggpubr::rremove("y.ticks") +
  labs(title = "(Non-)wear time distribution across the week", x = "Percentage of time (%)") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 24),
        axis.text.x = element_text(size = 16),
        axis.title = element_text(size = 18),
        axis.text.y = element_text(size = 16))

#Same plot without jitter and boxplot, just with distribution
  states_dist_histo <- ggplot(data = int_types, aes(x=per_length, y = State, fill = State)) +
  xlim(NA,100) +
  ggdist::stat_halfeye(
    aes(colour = State,
        fill = State),
    adjust = .5,
    point_color = NA,
    interval_color = NA
 #   .width = .7
    ) +
  ggdist::stat_dotsinterval(
    side = "bottom",
    scale = .3,
    slab_colour = NA,
    slab_linewidth = NA) +
  scale_fill_manual(
    values = c("off" = "#16439C", "on" = "palegreen4", "sleep" = "darkgoldenrod2")) +
  scale_y_discrete(labels = c("on" = "On", "off" = "Off", "sleep" = "Off while\nsleeping")) +
  theme_classic() +
  ggpubr::rremove("ylab") +
  ggpubr::rremove("y.ticks") +
  labs(title = "(Non-)wear time distribution across the week", x = "Percentage of time (%)") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 24),
        axis.text.x = element_text(size = 16),
        axis.title = element_text(size = 18),
        axis.text.y = element_text(size = 16))


```

###Save plot above
```{r}
ggsave(filename = "state_dist_jitter.png",
       plot = states_dist_jitter ,
       width = 8,
       height = 5,
       dpi = 600,
       path= "F:/cyepi/code/outputs")
```
